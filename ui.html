<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: Inter, sans-serif;
      margin: 0;
      padding: 20px;
      padding-bottom: 40px;
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
      overflow-y: auto;
    }
    
    h2 {
      margin: 0 0 20px 0;
      font-size: 18px;
      font-weight: 600;
    }
    
    .button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      background: #18A0FB;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .button:hover {
      background: #0D8DE3;
    }
    
    .button:active {
      background: #0B7BC7;
    }
    
    .button:disabled {
      background: #E5E5E5;
      color: #999;
      cursor: not-allowed;
    }
    
    .chat-section {
      margin-top: 24px;
    }
    
    .selection-banner {
      background: #F0F8FF;
      border: 1px solid #D1E7FF;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .selection-icon {
      width: 16px;
      height: 16px;
      background: #18A0FB;
      border-radius: 2px;
      flex-shrink: 0;
    }
    
    .selection-text {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }
    
    .selection-count {
      font-weight: 600;
      color: #18A0FB;
    }
    
    .no-selection {
      background: #F8F9FA;
      border-color: #E9ECEF;
    }
    
    .no-selection .selection-icon {
      background: #6C757D;
    }
    
    .no-selection .selection-text {
      color: #6C757D;
    }
    
    .no-selection .selection-count {
      color: #6C757D;
    }
    
    .chat-input-container {
      display: flex;
      position: relative;
      box-sizing: border-box;
    }
    
    .chat-input {
      background-color: var(--figma-color-bg-secondary);
      flex: 1;
      padding: 12px 16px 56px;
      border-radius: 16px;
      box-sizing: border-box;
      font-size: 13px;
      font-family: Inter, sans-serif;
      font-weight: 400;
      height: 148px;
      min-height: 148px;
      line-height: 20px;
      overflow-y: auto;
      word-wrap: break-word;
      white-space: pre-wrap;
      outline: none;
    }
    
    .chat-input:focus {
      outline: none;
    }
    
    .chat-input[data-placeholder]:empty:before {
      content: attr(data-placeholder);
      color: var(--figma-color-text-disabled);
      pointer-events: none;
    }
    
    .send-button {
      width: 32px;
      height: 32px;
      min-width: 32px;
      min-height: 32px;
      max-width: 32px;
      max-height: 32px;
      padding: 0;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-on-brand);
      border: none;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      position: absolute;
      right: 8px;
      bottom: 8px;
    }
    .send-button svg {
      width: 16px;
      height: 16px;
      display: block;
      fill: var(--figma-color-text-on-brand);
    }
    .send-button.loading {
      background: #6C757D;
      cursor: not-allowed;
    }
    .send-button .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-top: 2px solid #18A0FB;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      box-sizing: border-box;
      display: block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .api-key-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #E5E5E5;
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
      box-sizing: border-box;
    }
    
    .api-key-input:focus {
      outline: none;
      border-color: #18A0FB;
      box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.1);
    }
    
    .api-key-label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .api-key-status {
      font-size: 12px;
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 4px;
      display: none;
    }
    
    .api-key-status.valid {
      background: #D4EDDA;
      color: #155724;
      border: 1px solid #C3E6CB;
      display: block;
    }
    
    .api-key-status.invalid {
      background: #F8D7DA;
      color: #721C24;
      border: 1px solid #F5C6CB;
      display: block;
    }
    
    .response-area {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.4;
      display: none;
    }
    
    .response-area.success {
      background: #D4EDDA;
      color: #155724;
      border: 1px solid #C3E6CB;
      display: block;
    }
    
    .response-area.error {
      background: #F8D7DA;
      color: #721C24;
      border: 1px solid #F5C6CB;
      display: block;
    }
    
    .response-area.loading {
      background: #D1ECF1;
      color: #0C5460;
      border: 1px solid #BEE5EB;
      display: block;
    }
    
    .send-button.loading {
      background: #6C757D;
      cursor: not-allowed;
    }
    
    .send-button.loading::after {
      content: '';
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <div class="chat-section">
      
      <div class="selection-banner" id="selection-banner">
        <div class="selection-icon"></div>
        <div class="selection-text">
          <span id="selection-count">0</span> element<span id="selection-plural">s</span> selected
        </div>
      </div>
      
      <div class="chat-input-container">
        <span id="key-icon" style="float: right; cursor: pointer; font-size: 20px; margin-top: 4px;" title="Set API Key">🔑</span>
        <div 
          class="chat-input" 
          id="chat-input" 
          contenteditable="true"
          data-placeholder="Type your message here..."
        ></div>
        <button class="send-button" id="send-button" disabled aria-label="Send">
          <svg id="send-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.0306 7.53065C12.9609 7.60057 12.8781 7.65605 12.787 7.6939C12.6958 7.73176 12.5981 7.75124 12.4993 7.75124C12.4006 7.75124 12.3029 7.73176 12.2117 7.6939C12.1206 7.65605 12.0378 7.60057 11.9681 7.53065L8.74997 4.31253V13.5C8.74997 13.6989 8.67095 13.8897 8.5303 14.0304C8.38965 14.171 8.19888 14.25 7.99997 14.25C7.80106 14.25 7.61029 14.171 7.46964 14.0304C7.32899 13.8897 7.24997 13.6989 7.24997 13.5V4.31253L4.0306 7.53065C3.8897 7.67155 3.69861 7.7507 3.49935 7.7507C3.30009 7.7507 3.10899 7.67155 2.9681 7.53065C2.8272 7.38975 2.74805 7.19866 2.74805 6.9994C2.74805 6.80014 2.8272 6.60905 2.9681 6.46815L7.4681 1.96815C7.53778 1.89823 7.62057 1.84275 7.71173 1.8049C7.8029 1.76704 7.90064 1.74756 7.99935 1.74756C8.09806 1.74756 8.1958 1.76704 8.28696 1.8049C8.37813 1.84275 8.46092 1.89823 8.5306 1.96815L13.0306 6.46815C13.1005 6.53783 13.156 6.62062 13.1938 6.71179C13.2317 6.80295 13.2512 6.90069 13.2512 6.9994C13.2512 7.09811 13.2317 7.19585 13.1938 7.28701C13.156 7.37818 13.1005 7.46097 13.0306 7.53065Z" fill="white"/>
          </svg>
        </button>
      </div>
      
      <div class="response-area" id="response-area"></div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.2); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 24px 20px 20px 20px; border-radius: 8px; box-shadow: 0 2px 16px rgba(0,0,0,0.15); min-width: 320px; position: relative;">
        <button id="close-modal" style="position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
        <label class="api-key-label" for="api-key-input-modal">OpenAI API Key</label>
        <input 
          type="password" 
          class="api-key-input" 
          id="api-key-input-modal" 
          placeholder="sk-..."
          autocomplete="off"
          style="margin-bottom: 12px;"
        />
        <div class="api-key-status" id="api-key-status-modal"></div>
      </div>
    </div>
  </div>

  <script>
    // Chat functionality
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const responseArea = document.getElementById('response-area');
    
    // Update send button state based on input content
    function updateSendButton() {
      const hasContent = chatInput.textContent.trim().length > 0;
      sendButton.disabled = !hasContent || sendButton.classList.contains('loading');
    }
    
    // Show response in UI
    function showResponse(message, type = 'success') {
      responseArea.textContent = message;
      responseArea.className = `response-area ${type}`;
    }
    
    // Clear response
    function clearResponse() {
      responseArea.className = 'response-area';
      responseArea.textContent = '';
    }
    
    // Set loading state
    function setLoading(loading) {
      if (loading) {
        sendButton.classList.add('loading');
        sendButton.innerHTML = '<span class="spinner"></span>';
        showResponse('🤔 Thinking...', 'loading');
      } else {
        sendButton.classList.remove('loading');
        sendButton.innerHTML = '<svg id="send-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.0306 7.53065C12.9609 7.60057 12.8781 7.65605 12.787 7.6939C12.6958 7.73176 12.5981 7.75124 12.4993 7.75124C12.4006 7.75124 12.3029 7.73176 12.2117 7.6939C12.1206 7.65605 12.0378 7.60057 11.9681 7.53065L8.74997 4.31253V13.5C8.74997 13.6989 8.67095 13.8897 8.5303 14.0304C8.38965 14.171 8.19888 14.25 7.99997 14.25C7.80106 14.25 7.61029 14.171 7.46964 14.0304C7.32899 13.8897 7.24997 13.6989 7.24997 13.5V4.31253L4.0306 7.53065C3.8897 7.67155 3.69861 7.7507 3.49935 7.7507C3.30009 7.7507 3.10899 7.67155 2.9681 7.53065C2.8272 7.38975 2.74805 7.19866 2.74805 6.9994C2.74805 6.80014 2.8272 6.60905 2.9681 6.46815L7.4681 1.96815C7.53778 1.89823 7.62057 1.84275 7.71173 1.8049C7.8029 1.76704 7.90064 1.74756 7.99935 1.74756C8.09806 1.74756 8.1958 1.76704 8.28696 1.8049C8.37813 1.84275 8.46092 1.89823 8.5306 1.96815L13.0306 6.46815C13.1005 6.53783 13.156 6.62062 13.1938 6.71179C13.2317 6.80295 13.2512 6.90069 13.2512 6.9994C13.2512 7.09811 13.2317 7.19585 13.1938 7.28701C13.156 7.37818 13.1005 7.46097 13.0306 7.53065Z" fill="white"/></svg>';
      }
      updateSendButton();
    }
    
    // Auto-resize function for contenteditable
    function autoResize() {
      chatInput.style.height = 'auto';
      const scrollHeight = chatInput.scrollHeight;
      const maxHeight = 148; // matches CSS max-height
      chatInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
    }
    
    // Handle input changes
    chatInput.addEventListener('input', () => {
      updateSendButton();
      autoResize();
    });
    
    // Handle send button click
    sendButton.addEventListener('click', () => {
      const message = chatInput.textContent.trim();
      if (message && !sendButton.classList.contains('loading')) {
        setLoading(true);
        clearResponse();
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'send-chat-message',
            message: message 
          } 
        }, '*');
        
        chatInput.textContent = '';
        updateSendButton();
      }
    });
    
    // Handle Enter key to send message
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendButton.click();
      }
    });
    
    // Initialize the input height
    autoResize();
    
    // Selection counter display updates
    const selectionBanner = document.getElementById('selection-banner');
    const selectionCount = document.getElementById('selection-count');
    const selectionPlural = document.getElementById('selection-plural');
    
    // Update selection display
    function updateSelectionDisplay(count) {
      selectionCount.textContent = count;
      selectionPlural.textContent = count === 1 ? '' : 's';
      
      if (count === 0) {
        selectionBanner.classList.add('no-selection');
      } else {
        selectionBanner.classList.remove('no-selection');
      }
    }
    
    // Listen for selection updates from the plugin
    window.addEventListener('message', (event) => {
      if (event.data.pluginMessage && event.data.pluginMessage.type === 'selection-update') {
        const count = event.data.pluginMessage.count;
        updateSelectionDisplay(count);
      }
      
      if (event.data.pluginMessage && event.data.pluginMessage.type === 'chat-response') {
        // Handle chat response from plugin
        const response = event.data.pluginMessage;
        setLoading(response.loading);
        
        if (response.success) {
          if (response.loading) {
            showResponse(response.message, 'loading');
          } else {
            showResponse('✅ Response added to Figma canvas!', 'success');
            // Clear the response after a few seconds
            setTimeout(clearResponse, 3000);
          }
        } else {
          showResponse('❌ ' + response.message, 'error');
        }
      }
      
      if (event.data.pluginMessage && event.data.pluginMessage.type === 'api-key-loaded') {
        // Load saved API key into input
        const savedApiKey = event.data.pluginMessage.apiKey;
        apiKeyInputModal.value = savedApiKey;
        updateApiKeyStatusModal(savedApiKey);
      }
    });
    
    // Request initial selection count
    parent.postMessage({ pluginMessage: { type: 'get-selection-count' } }, '*');
    
    // Remove accordion and config controls
    // Add modal logic
    const keyIcon = document.getElementById('key-icon');
    const apiKeyModal = document.getElementById('api-key-modal');
    const apiKeyInputModal = document.getElementById('api-key-input-modal');
    const apiKeyStatusModal = document.getElementById('api-key-status-modal');
    const saveApiKeyModal = document.getElementById('save-api-key-modal');
    const closeModal = document.getElementById('close-modal');

    // Remove Save button logic, add auto-save and status logic
    let apiKeyInputModalSaveTimeout;
    keyIcon.addEventListener('click', () => {
      apiKeyModal.style.display = 'flex';
      // Request the saved API key from the plugin
      parent.postMessage({ pluginMessage: { type: 'get-api-key' } }, '*');
    });
    closeModal.addEventListener('click', () => {
      apiKeyModal.style.display = 'none';
    });
    apiKeyModal.addEventListener('click', (e) => {
      if (e.target === apiKeyModal) apiKeyModal.style.display = 'none';
    });
    function validateApiKey(key) {
      return key.startsWith('sk-') && key.length > 20;
    }
    function updateApiKeyStatusModal(key) {
      if (!key) {
        apiKeyStatusModal.className = 'api-key-status';
        apiKeyStatusModal.textContent = '';
        return;
      }
      if (validateApiKey(key)) {
        apiKeyStatusModal.className = 'api-key-status valid';
        apiKeyStatusModal.textContent = '✓ Valid API key format';
      } else {
        apiKeyStatusModal.className = 'api-key-status invalid';
        apiKeyStatusModal.textContent = '✗ Invalid API key format';
      }
    }
    apiKeyInputModal.addEventListener('input', (e) => {
      const key = e.target.value;
      updateApiKeyStatusModal(key);
      clearTimeout(apiKeyInputModalSaveTimeout);
      apiKeyInputModalSaveTimeout = setTimeout(() => {
        if (validateApiKey(key)) {
          parent.postMessage({ pluginMessage: { type: 'save-api-key', apiKey: key } }, '*');
        }
      }, 500);
    });
    // When receiving the saved API key, show it masked and update status
    window.addEventListener('message', (event) => {
      if (event.data.pluginMessage && event.data.pluginMessage.type === 'api-key-loaded') {
        const savedApiKey = event.data.pluginMessage.apiKey;
        apiKeyInputModal.value = savedApiKey || '';
        updateApiKeyStatusModal(savedApiKey);
      }
    });
  </script>
</body>
</html> 