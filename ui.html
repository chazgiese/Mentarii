<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: Inter, sans-serif;
      margin: 0;
      padding: 20px;
      padding-bottom: 40px;
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
      overflow-y: auto;
    }
    
    h2 {
      margin: 0 0 20px 0;
      font-size: 18px;
      font-weight: 600;
    }
    
    .button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      background: #18A0FB;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .button:hover {
      background: #0D8DE3;
    }
    
    .button:active {
      background: #0B7BC7;
    }
    
    .button:disabled {
      background: #E5E5E5;
      color: #999;
      cursor: not-allowed;
    }
    
    .chat-section {
      margin-top: 24px;
    }
    
    .selection-banner {
      background: #F0F8FF;
      border: 1px solid #D1E7FF;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .selection-icon {
      width: 16px;
      height: 16px;
      background: #18A0FB;
      border-radius: 2px;
      flex-shrink: 0;
    }
    
    .selection-text {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }
    
    .selection-count {
      font-weight: 600;
      color: #18A0FB;
    }
    
    .no-selection {
      background: #F8F9FA;
      border-color: #E9ECEF;
    }
    
    .no-selection .selection-icon {
      background: #6C757D;
    }
    
    .no-selection .selection-text {
      color: #6C757D;
    }
    
    .no-selection .selection-count {
      color: #6C757D;
    }
    
    .chat-input-container {
      display: flex;
      position: relative;
      box-sizing: border-box;
    }
    
    .chat-input {
      background-color: var(--figma-color-bg-secondary);
      flex: 1;
      padding: 12px 16px 56px;
      border-radius: 16px;
      box-sizing: border-box;
      font-size: 13px;
      font-family: Inter, sans-serif;
      font-weight: 400;
      height: 148px;
      min-height: 148px;
      line-height: 20px;
      overflow-y: auto;
      word-wrap: break-word;
      white-space: pre-wrap;
      outline: none;
    }
    
    .chat-input:focus {
      outline: none;
    }
    
    .chat-input[data-placeholder]:empty:before {
      content: attr(data-placeholder);
      color: var(--figma-color-text-disabled);
      pointer-events: none;
    }
    
    .send-button {
      width: 32px;
      height: 32px;
      min-width: 32px;
      min-height: 32px;
      max-width: 32px;
      max-height: 32px;
      padding: 0;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-on-brand);
      border: none;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      position: absolute;
      right: 8px;
      bottom: 8px;
    }
    .send-button svg {
      width: 16px;
      height: 16px;
      display: block;
      fill: var(--figma-color-text-on-brand);
    }
    .send-button.loading {
      background: #6C757D;
      cursor: not-allowed;
    }
    .send-button .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-top: 2px solid #18A0FB;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      box-sizing: border-box;
      display: block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chat-button {
      background: none;
      border: none;
      position: absolute;
      height: 32px;
      width: 32px;
      bottom: 8px;
      left: 8px;
      font-size: 20px;
      cursor: pointer;
    }
    
    .api-key-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #E5E5E5;
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
      box-sizing: border-box;
    }
    
    .api-key-input:focus {
      outline: none;
      border-color: #18A0FB;
      box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.1);
    }
    
    .api-key-label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .api-key-status {
      font-size: 12px;
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 4px;
      display: none;
    }
    
    .api-key-status.valid {
      background: #D4EDDA;
      color: #155724;
      border: 1px solid #C3E6CB;
      display: block;
    }
    
    .api-key-status.invalid {
      background: #F8D7DA;
      color: #721C24;
      border: 1px solid #F5C6CB;
      display: block;
    }
    
    .response-area {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.4;
      display: none;
    }
    
    .response-area.success {
      background: #D4EDDA;
      color: #155724;
      border: 1px solid #C3E6CB;
      display: block;
    }
    
    .response-area.error {
      background: #F8D7DA;
      color: #721C24;
      border: 1px solid #F5C6CB;
      display: block;
    }
    
    .response-area.loading {
      background: #D1ECF1;
      color: #0C5460;
      border: 1px solid #BEE5EB;
      display: block;
    }
    
    .send-button.loading {
      background: #6C757D;
      cursor: not-allowed;
    }
    
    .send-button.loading::after {
      content: '';
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <div class="chat-section">
      
      <!-- Removed selection-banner and selected element counter UI -->
      
      <div class="chat-input-container">
        <div 
          class="chat-input" 
          id="chat-input" 
          contenteditable="true"
          data-placeholder="Type your message here..."
        ></div>
        <button class="chat-button" id="key-icon" style="float: right; cursor: pointer; font-size: 20px; margin-top: 4px;" title="Set API Key">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 5.49998H4.5625C4.67265 5.93019 4.92285 6.3115 5.27365 6.5838C5.62446 6.85611 6.05591 7.00391 6.5 7.00391C6.94409 7.00391 7.37554 6.85611 7.72635 6.5838C8.07715 6.3115 8.32735 5.93019 8.4375 5.49998H13.5C13.6326 5.49998 13.7598 5.44731 13.8536 5.35354C13.9473 5.25977 14 5.13259 14 4.99998C14 4.86738 13.9473 4.7402 13.8536 4.64643C13.7598 4.55266 13.6326 4.49998 13.5 4.49998H8.4375C8.32735 4.06978 8.07715 3.68847 7.72635 3.41617C7.37554 3.14386 6.94409 2.99606 6.5 2.99606C6.05591 2.99606 5.62446 3.14386 5.27365 3.41617C4.92285 3.68847 4.67265 4.06978 4.5625 4.49998H2.5C2.36739 4.49998 2.24021 4.55266 2.14645 4.64643C2.05268 4.7402 2 4.86738 2 4.99998C2 5.13259 2.05268 5.25977 2.14645 5.35354C2.24021 5.44731 2.36739 5.49998 2.5 5.49998ZM6.5 3.99998C6.69778 3.99998 6.89112 4.05863 7.05557 4.16852C7.22002 4.2784 7.34819 4.43458 7.42388 4.6173C7.49957 4.80003 7.51937 5.00109 7.48079 5.19508C7.4422 5.38906 7.34696 5.56724 7.20711 5.70709C7.06725 5.84694 6.88907 5.94219 6.69509 5.98077C6.50111 6.01936 6.30004 5.99955 6.11732 5.92386C5.93459 5.84818 5.77841 5.72 5.66853 5.55556C5.55865 5.39111 5.5 5.19777 5.5 4.99998C5.5 4.73477 5.60536 4.48041 5.79289 4.29288C5.98043 4.10534 6.23478 3.99998 6.5 3.99998ZM13.5 10.5H12.4375C12.3273 10.0698 12.0771 9.68847 11.7263 9.41617C11.3755 9.14386 10.9441 8.99606 10.5 8.99606C10.0559 8.99606 9.62446 9.14386 9.27365 9.41617C8.92285 9.68847 8.67265 10.0698 8.5625 10.5H2.5C2.36739 10.5 2.24021 10.5527 2.14645 10.6464C2.05268 10.7402 2 10.8674 2 11C2 11.1326 2.05268 11.2598 2.14645 11.3535C2.24021 11.4473 2.36739 11.5 2.5 11.5H8.5625C8.67265 11.9302 8.92285 12.3115 9.27365 12.5838C9.62446 12.8561 10.0559 13.0039 10.5 13.0039C10.9441 13.0039 11.3755 12.8561 11.7263 12.5838C12.0771 12.3115 12.3273 11.9302 12.4375 11.5H13.5C13.6326 11.5 13.7598 11.4473 13.8536 11.3535C13.9473 11.2598 14 11.1326 14 11C14 10.8674 13.9473 10.7402 13.8536 10.6464C13.7598 10.5527 13.6326 10.5 13.5 10.5ZM10.5 12C10.3022 12 10.1089 11.9413 9.94443 11.8315C9.77998 11.7216 9.65181 11.5654 9.57612 11.3827C9.50043 11.1999 9.48063 10.9989 9.51921 10.8049C9.5578 10.6109 9.65304 10.4327 9.79289 10.2929C9.93275 10.153 10.1109 10.0578 10.3049 10.0192C10.4989 9.98061 10.7 10.0004 10.8827 10.0761C11.0654 10.1518 11.2216 10.28 11.3315 10.4444C11.4414 10.6089 11.5 10.8022 11.5 11C11.5 11.2652 11.3946 11.5196 11.2071 11.7071C11.0196 11.8946 10.7652 12 10.5 12Z" fill="white"/></svg>
        </button>
        <button class="send-button" id="send-button" disabled aria-label="Send">
          <svg id="send-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.0306 7.53065C12.9609 7.60057 12.8781 7.65605 12.787 7.6939C12.6958 7.73176 12.5981 7.75124 12.4993 7.75124C12.4006 7.75124 12.3029 7.73176 12.2117 7.6939C12.1206 7.65605 12.0378 7.60057 11.9681 7.53065L8.74997 4.31253V13.5C8.74997 13.6989 8.67095 13.8897 8.5303 14.0304C8.38965 14.171 8.19888 14.25 7.99997 14.25C7.80106 14.25 7.61029 14.171 7.46964 14.0304C7.32899 13.8897 7.24997 13.6989 7.24997 13.5V4.31253L4.0306 7.53065C3.8897 7.67155 3.69861 7.7507 3.49935 7.7507C3.30009 7.7507 3.10899 7.67155 2.9681 7.53065C2.8272 7.38975 2.74805 7.19866 2.74805 6.9994C2.74805 6.80014 2.8272 6.60905 2.9681 6.46815L7.4681 1.96815C7.53778 1.89823 7.62057 1.84275 7.71173 1.8049C7.8029 1.76704 7.90064 1.74756 7.99935 1.74756C8.09806 1.74756 8.1958 1.76704 8.28696 1.8049C8.37813 1.84275 8.46092 1.89823 8.5306 1.96815L13.0306 6.46815C13.1005 6.53783 13.156 6.62062 13.1938 6.71179C13.2317 6.80295 13.2512 6.90069 13.2512 6.9994C13.2512 7.09811 13.2317 7.19585 13.1938 7.28701C13.156 7.37818 13.1005 7.46097 13.0306 7.53065Z" fill="white"/></svg>
        </button>
      </div>
      
      <div class="response-area" id="response-area"></div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.2); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 24px 20px 20px 20px; border-radius: 8px; box-shadow: 0 2px 16px rgba(0,0,0,0.15); min-width: 320px; position: relative;">
        <button id="close-modal" style="position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
        <label class="api-key-label" for="api-key-input-modal">OpenAI API Key</label>
        <input 
          type="password" 
          class="api-key-input" 
          id="api-key-input-modal" 
          placeholder="sk-..."
          autocomplete="off"
          style="margin-bottom: 12px;"
        />
        <div class="api-key-status" id="api-key-status-modal"></div>
      </div>
    </div>
  </div>

  <script>
    // Chat functionality
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const responseArea = document.getElementById('response-area');
    
    // Update send button state based on input content
    function updateSendButton() {
      const hasContent = chatInput.textContent.trim().length > 0;
      sendButton.disabled = !hasContent || sendButton.classList.contains('loading');
    }
    
    // Show response in UI
    function showResponse(message, type = 'success') {
      responseArea.textContent = message;
      responseArea.className = `response-area ${type}`;
    }
    
    // Clear response
    function clearResponse() {
      responseArea.className = 'response-area';
      responseArea.textContent = '';
    }
    
    // Set loading state
    function setLoading(loading) {
      if (loading) {
        sendButton.classList.add('loading');
        sendButton.innerHTML = '<span class="spinner"></span>';
        showResponse('ðŸ¤” Thinking...', 'loading');
      } else {
        sendButton.classList.remove('loading');
        sendButton.innerHTML = '<svg id="send-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.0306 7.53065C12.9609 7.60057 12.8781 7.65605 12.787 7.6939C12.6958 7.73176 12.5981 7.75124 12.4993 7.75124C12.4006 7.75124 12.3029 7.73176 12.2117 7.6939C12.1206 7.65605 12.0378 7.60057 11.9681 7.53065L8.74997 4.31253V13.5C8.74997 13.6989 8.67095 13.8897 8.5303 14.0304C8.38965 14.171 8.19888 14.25 7.99997 14.25C7.80106 14.25 7.61029 14.171 7.46964 14.0304C7.32899 13.8897 7.24997 13.6989 7.24997 13.5V4.31253L4.0306 7.53065C3.8897 7.67155 3.69861 7.7507 3.49935 7.7507C3.30009 7.7507 3.10899 7.67155 2.9681 7.53065C2.8272 7.38975 2.74805 7.19866 2.74805 6.9994C2.74805 6.80014 2.8272 6.60905 2.9681 6.46815L7.4681 1.96815C7.53778 1.89823 7.62057 1.84275 7.71173 1.8049C7.8029 1.76704 7.90064 1.74756 7.99935 1.74756C8.09806 1.74756 8.1958 1.76704 8.28696 1.8049C8.37813 1.84275 8.46092 1.89823 8.5306 1.96815L13.0306 6.46815C13.1005 6.53783 13.156 6.62062 13.1938 6.71179C13.2317 6.80295 13.2512 6.90069 13.2512 6.9994C13.2512 7.09811 13.2317 7.19585 13.1938 7.28701C13.156 7.37818 13.1005 7.46097 13.0306 7.53065Z" fill="white"/></svg>';
      }
      updateSendButton();
    }
    
    // Auto-resize function for contenteditable
    function autoResize() {
      chatInput.style.height = 'auto';
      const scrollHeight = chatInput.scrollHeight;
      const maxHeight = 148; // matches CSS max-height
      chatInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
    }
    
    // Handle input changes
    chatInput.addEventListener('input', () => {
      updateSendButton();
      autoResize();
    });
    
    // Handle send button click
    sendButton.addEventListener('click', () => {
      const message = chatInput.textContent.trim();
      if (message && !sendButton.classList.contains('loading')) {
        setLoading(true);
        clearResponse();
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'send-chat-message',
            message: message 
          } 
        }, '*');
        
        chatInput.textContent = '';
        updateSendButton();
      }
    });
    
    // Handle Enter key to send message
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendButton.click();
      }
    });
    
    // Initialize the input height
    autoResize();
    
    // Selection counter display updates
    // Removed selectionBanner, selectionCount, selectionPlural
    
    // Listen for selection updates from the plugin
    window.addEventListener('message', (event) => {
      // Removed selection-update handling
      
      if (event.data.pluginMessage && event.data.pluginMessage.type === 'chat-response') {
        // Handle chat response from plugin
        const response = event.data.pluginMessage;
        setLoading(response.loading);
        
        if (response.success) {
          if (response.loading) {
            showResponse(response.message, 'loading');
          } else {
            showResponse('âœ… Response added to Figma canvas!', 'success');
            // Clear the response after a few seconds
            setTimeout(clearResponse, 3000);
          }
        } else {
          showResponse('âŒ ' + response.message, 'error');
        }
      }
      
      if (event.data.pluginMessage && event.data.pluginMessage.type === 'api-key-loaded') {
        // Load saved API key into input
        const savedApiKey = event.data.pluginMessage.apiKey;
        apiKeyInputModal.value = savedApiKey;
        updateApiKeyStatusModal(savedApiKey);
      }
    });
    
    // Request initial selection count
    // Removed parent.postMessage({ pluginMessage: { type: 'get-selection-count' } }, '*');
    
    // Remove accordion and config controls
    // Add modal logic
    const keyIcon = document.getElementById('key-icon');
    const apiKeyModal = document.getElementById('api-key-modal');
    const apiKeyInputModal = document.getElementById('api-key-input-modal');
    const apiKeyStatusModal = document.getElementById('api-key-status-modal');
    const saveApiKeyModal = document.getElementById('save-api-key-modal');
    const closeModal = document.getElementById('close-modal');

    // Remove Save button logic, add auto-save and status logic
    let apiKeyInputModalSaveTimeout;
    keyIcon.addEventListener('click', () => {
      apiKeyModal.style.display = 'flex';
      // Request the saved API key from the plugin
      parent.postMessage({ pluginMessage: { type: 'get-api-key' } }, '*');
    });
    closeModal.addEventListener('click', () => {
      apiKeyModal.style.display = 'none';
    });
    apiKeyModal.addEventListener('click', (e) => {
      if (e.target === apiKeyModal) apiKeyModal.style.display = 'none';
    });
    function validateApiKey(key) {
      return key.startsWith('sk-') && key.length > 20;
    }
    function updateApiKeyStatusModal(key) {
      if (!key) {
        apiKeyStatusModal.className = 'api-key-status';
        apiKeyStatusModal.textContent = '';
        return;
      }
      if (validateApiKey(key)) {
        apiKeyStatusModal.className = 'api-key-status valid';
        apiKeyStatusModal.textContent = 'âœ“ Valid API key format';
      } else {
        apiKeyStatusModal.className = 'api-key-status invalid';
        apiKeyStatusModal.textContent = 'âœ— Invalid API key format';
      }
    }
    apiKeyInputModal.addEventListener('input', (e) => {
      const key = e.target.value;
      updateApiKeyStatusModal(key);
      clearTimeout(apiKeyInputModalSaveTimeout);
      apiKeyInputModalSaveTimeout = setTimeout(() => {
        if (validateApiKey(key)) {
          parent.postMessage({ pluginMessage: { type: 'save-api-key', apiKey: key } }, '*');
        }
      }, 500);
    });
    // When receiving the saved API key, show it masked and update status
    window.addEventListener('message', (event) => {
      if (event.data.pluginMessage && event.data.pluginMessage.type === 'api-key-loaded') {
        const savedApiKey = event.data.pluginMessage.apiKey;
        apiKeyInputModal.value = savedApiKey || '';
        updateApiKeyStatusModal(savedApiKey);
      }
    });
  </script>
</body>
</html> 